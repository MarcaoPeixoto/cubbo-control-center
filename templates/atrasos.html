<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atrasos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin-left: 5%;
            margin-right: 5%;
        }
        .dashboard {
            display: flex;
            justify-content: space-between;
        }
        .filters {
            display: flex;
            justify-content: space-between;
            margin-top: 5%;
            margin-bottom: 3%;
            width: 100%;
            max-width: 100%;
        }
        .filter-dropdown, .filter-date, .filter-button {
            background-color: #0052cc;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;  /* Added border-radius */
            padding: 8px 12px;   /* Added padding for better appearance */
        }
        .legend {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .legend-item {
            margin: 0 10px;
        }
        .chart-container {
            display: flex;
            justify-content: space-between;
        }
        .bar-chart {
            width: 40%;
        }
        .pie-chart {
            width: 40%;
        }
        .bar {
            height: 20px;
            margin: 5px 0;
        }
        .loggi { background-color: blue; }
        .correios { background-color: yellow; }
        .cubbo { background-color: red; }
        .chart {
            width: 30%;
        }
        #totalAtrasos {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        option {
            color: white;
            font-size: 1em;
        }
        #marca, #transportadora, #status, #dataInicio, #dataFim {
            margin-left: 5px;
            margin-right: 5px;
        }
        label {
            color: black;
            font-size: 0.7em;
            margin-left: 5%;
            background-color: white;
        }
        .date-input-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin: 0 5px;
        }
        .date-input-container label {
            background-color: white;
            color: black;
            padding: 5px 0;
            font-size: 0.8em;
            text-align: center;
            margin-bottom: -1px;
            border-radius: 5px 5px 0 0;  /* Rounded top corners */
        }
        .filter-date {
            padding: 8px 12px;  /* Adjusted padding */
            width: 100%;
            border-radius: 0 0 5px 5px;  /* Rounded bottom corners */
        }
        #dateChart {
            margin-right: 0;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="filters">
        <select id="marca" class="filter-dropdown">
            <option value="None">Todas Marcas</option>
            <option value="30PORCENTO">30PORCENTO</option>
            <option value="ABOVE AVERAGE">ABOVE AVERAGE</option>
            <option value="Abra Cadabra">Abra Cadabra</option>
            <option value="Ádive Health">Ádive Health</option>
            <option value="ALFAJORES ODARA">ALFAJORES ODARA</option>
            <option value="Ana Martha">Ana Martha</option>
            <option value="Anifree Comercial Importadora e Distribuidora Ltda">Anifree Comercial Importadora e Distribuidora Ltda</option>
            <option value="Associação Quatro Cinco Um">Associação Quatro Cinco Um</option>
            <option value="Autonomia Literária">Autonomia Literária</option>
            <option value="Batidora Ediciones Brasil">Batidora Ediciones Brasil</option>
            <option value="Beautycolor Company">Beautycolor Company</option>
            <option value="Bhāva">Bhāva</option>
            <option value="Biowash">Biowash</option>
            <option value="Boitempo">Boitempo</option>
            <option value="Bossa">Bossa</option>
            <option value="CapyCat Games">CapyCat Games</option>
            <option value="Caunutro Capacitação">Caunutro Capacitação</option>
            <option value="Cerrado Bike Shop SP">Cerrado Bike Shop SP</option>
            <option value="CHEETED">CHEETED</option>
            <option value="Cleantella">Cleantella</option>
            <option value="ClearMud Editora">ClearMud Editora</option>
            <option value="Clube do Livro do Design">Clube do Livro do Design</option>
            <option value="Cubbo Brasil - Loja Online">Cubbo Brasil - Loja Online</option>
            <option value="D20 Culture">D20 Culture</option>
            <option value="Dermastic">Dermastic</option>
            <option value="Divina Saúde">Divina Saúde</option>
            <option value="Dossier Brasil">Dossier Brasil</option>
            <option value="Duccato Brasil">Duccato Brasil</option>
            <option value="Editora Aleph">Editora Aleph</option>
            <option value="Editora Antofagica">Editora Antofagica</option>
            <option value="Editora Letramento">Editora Letramento</option>
            <option value="EGHO STUDIOS">EGHO STUDIOS</option>
            <option value="Elacura">Elacura</option>
            <option value="Eleva Calçados">Eleva Calçados</option>
            <option value="Fazzoletti">Fazzoletti</option>
            <option value="Florence Intimates">Florence Intimates</option>
            <option value="FOSFORO">FOSFORO</option>
            <option value="FreshFemme">FreshFemme</option>
            <option value="Gentle">Gentle</option>
            <option value="Grão de Gente">Grão de Gente</option>
            <option value="HARINA PAN BRASIL">HARINA PAN BRASIL</option>
            <option value="Healthy Market">Healthy Market</option>
            <option value="HOT SAT TELECOMUNICAÇÕES LTDA">HOT SAT TELECOMUNICAÇÕES LTDA</option>
            <option value="Insekta">Insekta</option>
            <option value="INSTITUTO HEALERS">INSTITUTO HEALERS</option>
            <option value="INSTITUTO SUPERANDO SEUS LIMITES">INSTITUTO SUPERANDO SEUS LIMITES</option>
            <option value="Intra Sports Nutrition">Intra Sports Nutrition</option>
            <option value="Jakobsson Estudio">Jakobsson Estudio</option>
            <option value="JE TECNOLOGIA E SEGURANCA DA INFORMACAO LTDA">JE TECNOLOGIA E SEGURANCA DA INFORMACAO LTDA</option>
            <option value="Joelma Decorações">Joelma Decorações</option>
            <option value="JustForYou">JustForYou</option>
            <option value="Keep Running">Keep Running</option>
            <option value="Lampadaria">Lampadaria</option>
            <option value="Latika">Latika</option>
            <option value="Leternel Ortomolecular - Creme TOE">Leternel Ortomolecular - Creme TOE</option>
            <option value="LET IT BE INTIMATE">LET IT BE INTIMATE</option>
            <option value="LG Holding">LG Holding</option>
            <option value="Lilaccie">Lilaccie</option>
            <option value="LM SOLUÇOES">LM SOLUÇOES</option>
            <option value="Loja Corrida Perfeita">Loja Corrida Perfeita</option>
            <option value="Ludopia Brinquedos Terapêuticos e Educativos">Ludopia Brinquedos Terapêuticos e Educativos</option>
            <option value="Mahta">Mahta</option>
            <option value="Mais Que um Café">Mais Que um Café</option>
            <option value="MAMD">MAMD</option>
            <option value="ManClub">ManClub</option>
            <option value="ManClub MG">ManClub MG</option>
            <option value="MapaLab">MapaLab</option>
            <option value="Mapear Direito">Mapear Direito</option>
            <option value="Mark Ryden Brasil">Mark Ryden Brasil</option>
            <option value="Median">Median</option>
            <option value="Mégalos Imports">Mégalos Imports</option>
            <option value="Meller BR">Meller BR</option>
            <option value="Monoï Original Precieux">Monoï Original Precieux</option>
            <option value="MOOSE baby e kids">MOOSE baby e kids</option>
            <option value="Mozambique">Mozambique</option>
            <option value="Namu Matcha">Namu Matcha</option>
            <option value="NOÀZIS">NOÀZIS</option>
            <option value="Nowhey Suplementos">Nowhey Suplementos</option>
            <option value="NutroSupp"></option>NutroSupp</option>
            <option value="oiwhite">oiwhite</option>
            <option value="Opera Beauty Brasil">Opera Beauty Brasil</option>
            <option value="Ozonivita">Ozonivita</option>    
            <option value="Pankz - Panquecas Americanas">Pankz - Panquecas Americanas</option>
            <option value="Pano Urbano">Pano Urbano</option>
            <option value="Parla">Parla</option>
            <option value="Perruche">Perruche</option>
            <option value="PRANA BEBIDAS LEVES">PRANA BEBIDAS LEVES</option>
            <option value="Quetzalli">Quetzalli</option>
            <option value="QuickPower®">QuickPower®</option>
            <option value="RAUTER LTDA">RAUTER LTDA</option>
            <option value="Sacia Mais">Sacia Mais</option>
            <option value="Sallpe">Sallpe</option>
            <option value="Shiguan">Shiguan</option>
            <option value="Simbioze Amazônica">Simbioze Amazônica</option>
            <option value="Smush Smart Mushrooms">Smush Smart Mushrooms</option>
            <option value="Soul Live">Soul Live</option>
            <option value="Stella Pietro Wine">Stella Pietro Wine</option>
            <option value="Suplint">Suplint</option>
            <option value="Tábua Cronológica da Bíblia">Tábua Cronológica da Bíblia</option>
            <option value="TAG Livros">TAG Livros</option>
            <option value="Takeya Brasil">Takeya Brasil</option>
            <option value="TERRAL NATURAL">TERRAL NATURAL</option>
            <option value="TerraNutri Pure">TerraNutri Pure</option>
            <option value="The Skin Belle">The Skin Belle</option>
            <option value="TucoMarket">TucoMarket</option>
            <option value="Ufoslabs">Ufoslabs</option>
            <option value="Urban Basics">Urban Basics</option>
            <option value="Vinsel">Vinsel</option>
            <option value="Violão Brasileiro">Violão Brasileiro</option>
            <option value="WeCann Academy">WeCann Academy</option>
            <!-- Add options dynamically -->
        </select>
        <select id="transportadora" class="filter-dropdown">
            <option value="None">Todas Transportadoras</option>
            <option value="JT Express">JT Express</option>
            <option value="LOGGI">LOGGI</option>
            <option value="CORREIOS">CORREIOS</option>
            <option value="CUBBO">CUBBO</option>
            <!-- Add options dynamically -->
        </select>
        <div class="date-input-container">
            <label for="dataInicio">Data Início</label>
            <input type="date" id="dataInicio" class="filter-date" onchange="this.value = this.value || null">
        </div>
        <div class="date-input-container">
            <label for="dataFim">Data Fim</label>
            <input type="date" id="dataFim" class="filter-date" onchange="this.value = this.value || null">
        </div>
        <select id="status" class="filter-dropdown">
            <option value="None">Todos Status</option>
            <option value="shipped">shipped</option>
            <option value="returned">returned</option>
            <option value="returning">returning</option>
            <!-- Add options dynamically -->
        </select>
        <button id="updateDataBtn" class="filter-button">Atualizar Dados</button>
    </div>

    <div class="legend">
        <div class="legend-item"><span style="color: blue;">■</span> Loggi</div>
        <div class="legend-item"><span style="color: yellow;">■</span> Correios</div>
        <div class="legend-item"><span style="color: red;">■</span> Cubbo</div>
    </div>

    <div class="dashboard">
        <div id="ufChart" class="chart">
            <h3>Atrasos por UF</h3>
            <canvas id="ufBarChart"></canvas>
        </div>

        <div id="pieChartContainer" class="chart">
            <div id="totalAtrasos">ATRASOS TOTAL: <span id="totalAtrasosValue">XXX</span></div>
            <canvas id="transportadoraPieChart"></canvas>
        </div>

        <div id="dateChart" class="chart">
            <h3>Atrasos por Data</h3>
            <canvas id="dateBarChart"></canvas>
        </div>
    </div>

    <script>
        // Function to update charts based on filter values
        function updateCharts() {
            // Get filter values
            const marca = document.getElementById('marca').value;
            const transportadora = document.getElementById('transportadora').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const status = document.getElementById('status').value;

            // Prepare the query parameters
            const params = new URLSearchParams({
                marca: marca !== 'None' ? marca : '',
                transportadora: transportadora !== 'None' ? transportadora : '',
                data_inicial: dataInicio,
                data_final: dataFim,
                status: status !== 'None' ? status : ''
            });

            // Fetch data with filter parameters
            fetch(`/get_atrasos?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    updateUFChart(data.uf_data);
                    updatePieChart(data.transportadora_data);
                    updateDateChart(data.date_data);
                    document.getElementById('totalAtrasosValue').textContent = data.total_atrasos;
                });
        }

        // Function to update UF bar chart
        function updateUFChart(data) {
            const ctx = document.getElementById('ufBarChart').getContext('2d');
            const labels = Object.keys(data);
            const datasets = [
                {
                    label: 'Loggi',
                    data: labels.map(uf => data[uf]['LOGGI'] || 0),
                    backgroundColor: 'blue'
                },
                {
                    label: 'Correios',
                    data: labels.map(uf => data[uf]['CORREIOS'] || 0),
                    backgroundColor: 'yellow'
                },
                {
                    label: 'Cubbo',
                    data: labels.map(uf => data[uf]['CUBBO'] || 0),
                    backgroundColor: 'red'
                }
            ];

            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            });
        }

        // Function to update transportadora pie chart
        function updatePieChart(data) {
            const ctx = document.getElementById('transportadoraPieChart').getContext('2d');
            const labels = Object.keys(data);
            const values = labels.map(label => data[label].count);
            const colors = ['blue', 'yellow', 'red'];

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Atrasos por Transportadora'
                        }
                    }
                }
            });
        }

        // Function to update date bar chart
        function updateDateChart(data) {
            const ctx = document.getElementById('dateBarChart').getContext('2d');
            const labels = Object.keys(data).sort();
            const datasets = [
                {
                    label: 'Loggi',
                    data: labels.map(date => data[date]['LOGGI'] || 0),
                    backgroundColor: 'blue'
                },
                {
                    label: 'Correios',
                    data: labels.map(date => data[date]['CORREIOS'] || 0),
                    backgroundColor: 'yellow'
                },
                {
                    label: 'Cubbo',
                    data: labels.map(date => data[date]['CUBBO'] || 0),
                    backgroundColor: 'red'
                }
            ];

            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            });
        }

        // Add this function to handle the data update
        function updateData() {
            document.getElementById('updateDataBtn').disabled = true;
            document.getElementById('updateDataBtn').textContent = 'Atualizando...';

            fetch('/update_data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Dados atualizados com sucesso!');
                        updateCharts();  // Refresh the charts with new data
                    } else {
                        alert('Erro ao atualizar dados: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Erro ao atualizar dados: ' + error);
                })
                .finally(() => {
                    document.getElementById('updateDataBtn').disabled = false;
                    document.getElementById('updateDataBtn').textContent = 'Atualizar Dados';
                });
        }

        // Add event listener to the update button
        document.getElementById('updateDataBtn').addEventListener('click', updateData);

        // Add event listeners to filter inputs
        document.getElementById('marca').addEventListener('change', updateCharts);
        document.getElementById('transportadora').addEventListener('change', updateCharts);
        document.getElementById('dataInicio').addEventListener('change', updateCharts);
        document.getElementById('dataFim').addEventListener('change', updateCharts);
        document.getElementById('status').addEventListener('change', updateCharts);

        // Initial chart load
        updateCharts();
    </script>
</body>
</html>
