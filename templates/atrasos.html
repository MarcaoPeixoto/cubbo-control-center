<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atrasos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin-left: 5%;
            margin-right: 5%;
            max-width: 100%;
            overflow-x: hidden;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            height: 100vh; /* Use full viewport height */
        }
        .filters {
            display: flex;
            justify-content: space-between;
            margin-top: 5%;
            margin-bottom: 3%;
            width: 100%;
            max-width: 100%;
        }
        .filter-dropdown, .filter-date, .filter-button {
            background-color: #0052cc;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;  /* Added border-radius */
            padding: 8px 12px;   /* Added padding for better appearance */
        }
        .legend {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .legend-item {
            margin: 0 10px;
        }
        .chart {
            position: relative; /* Add this to allow absolute positioning of canvas */
        }
        .chart canvas {
            position: absolute;
            top: 10%; /* Adjust based on your h3 height */
            left: 0;
            right: 0;
            bottom: 0;
        }

        #ufChart, #dateChart {
            width: 30%;
            height: 100%; /* Increased to 95% of viewport height */
            margin-bottom: 2%;
        }
        #pieChartContainer {
            width: 40%;
            height: 80vh; /* Same height as other charts */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        .bar {
            height: 20px;
            margin: 5px 0;
        }
        .loggi { background-color: aqua; }
        .correios { background-color: chartreuse; }
        .cubbo { background-color: #ed1e79; }
        .chart {
            width: 30%;
        }
        #totalAtrasos {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        option {
            color: white;
            font-size: 1em;
        }
        #marca, #transportadora, #status, #dataInicio, #dataFim {
            margin-left: 5px;
            margin-right: 5px;
        }
        label {
            color: black;
            font-size: 0.7em;
            margin-left: 5%;
            background-color: white;
        }
        .date-input-container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin: 0 5px;
        }
        .date-input-container label {
            background-color: white;
            color: black;
            padding: 5px 0;
            font-size: 0.8em;
            text-align: center;
            margin-bottom: -1px;
            border-radius: 5px 5px 0 0;  /* Rounded top corners */
        }
        .filter-date {
            padding: 8px 12px;  /* Adjusted padding */
            width: 100%;
            border-radius: 0 0 5px 5px;  /* Rounded bottom corners */
        }
        #dateChart {
            margin-right: 0;
        }
        #totalAtrasos {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #pieChartWrapper {
            width: 100%;
            height: 50vh; /* Adjust as needed */
            position: relative;
        }

        .atrasos-table {
            margin-top: 20px;
            width: 100%;
            overflow-x: auto;
            margin-top: 5%;
        }

        .atrasos-table table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
            margin-left: 0;
            margin-right: 0;
        }

        .atrasos-table th, .atrasos-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.6em;
        }

        .atrasos-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .atrasos-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .atrasos-table tr:hover {
            background-color: #f5f5f5;
        }

        #downloadBtn {
            width: 20px;
            height: 20px;
        }

        button {
            background-color: transparent;
            border-radius: 20%;
            border-color: #aec3e1;
            margin-left: 2%;
        }

        #atrasosTableHeader {
            display: flex;
            align-items: center;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="filters">
        <select id="marca" class="filter-dropdown">
            <option value="None">Todas Marcas</option>
            <option value="30PORCENTO">30PORCENTO</option>
            <option value="ABOVE AVERAGE">ABOVE AVERAGE</option>
            <option value="Abra Cadabra">Abra Cadabra</option>
            <option value="Ádive Health">Ádive Health</option>
            <option value="ALFAJORES ODARA">ALFAJORES ODARA</option>
            <option value="Ana Martha">Ana Martha</option>
            <option value="Anifree Comercial Importadora e Distribuidora Ltda">Anifree Comercial Importadora e Distribuidora Ltda</option>
            <option value="Associação Quatro Cinco Um">Associação Quatro Cinco Um</option>
            <option value="Autonomia Literária">Autonomia Literária</option>
            <option value="Batidora Ediciones Brasil">Batidora Ediciones Brasil</option>
            <option value="Beautycolor Company">Beautycolor Company</option>
            <option value="Bhāva">Bhāva</option>
            <option value="Biowash">Biowash</option>
            <option value="Boitempo">Boitempo</option>
            <option value="Bossa">Bossa</option>
            <option value="CapyCat Games">CapyCat Games</option>
            <option value="Caunutro Capacitação">Caunutro Capacitação</option>
            <option value="Cerrado Bike Shop SP">Cerrado Bike Shop SP</option>
            <option value="CHEETED">CHEETED</option>
            <option value="Cleantella">Cleantella</option>
            <option value="ClearMud Editora">ClearMud Editora</option>
            <option value="Clube do Livro do Design">Clube do Livro do Design</option>
            <option value="Cubbo Brasil - Loja Online">Cubbo Brasil - Loja Online</option>
            <option value="D20 Culture">D20 Culture</option>
            <option value="Dermastic">Dermastic</option>
            <option value="Divina Saúde">Divina Saúde</option>
            <option value="Dossier Brasil">Dossier Brasil</option>
            <option value="Duccato Brasil">Duccato Brasil</option>
            <option value="Editora Aleph">Editora Aleph</option>
            <option value="Editora Antofagica">Editora Antofagica</option>
            <option value="Editora Letramento">Editora Letramento</option>
            <option value="EGHO STUDIOS">EGHO STUDIOS</option>
            <option value="Elacura">Elacura</option>
            <option value="Eleva Calçados">Eleva Calçados</option>
            <option value="Fazzoletti">Fazzoletti</option>
            <option value="Florence Intimates">Florence Intimates</option>
            <option value="FOSFORO">FOSFORO</option>
            <option value="FreshFemme">FreshFemme</option>
            <option value="Gentle">Gentle</option>
            <option value="Grão de Gente">Grão de Gente</option>
            <option value="HARINA PAN BRASIL">HARINA PAN BRASIL</option>
            <option value="Healthy Market">Healthy Market</option>
            <option value="HOT SAT TELECOMUNICAÇÕES LTDA">HOT SAT TELECOMUNICAÇÕES LTDA</option>
            <option value="Insekta">Insekta</option>
            <option value="INSTITUTO HEALERS">INSTITUTO HEALERS</option>
            <option value="INSTITUTO SUPERANDO SEUS LIMITES">INSTITUTO SUPERANDO SEUS LIMITES</option>
            <option value="Intra Sports Nutrition">Intra Sports Nutrition</option>
            <option value="Jakobsson Estudio">Jakobsson Estudio</option>
            <option value="JE TECNOLOGIA E SEGURANCA DA INFORMACAO LTDA">JE TECNOLOGIA E SEGURANCA DA INFORMACAO LTDA</option>
            <option value="Joelma Decorações">Joelma Decorações</option>
            <option value="JustForYou">JustForYou</option>
            <option value="Keep Running">Keep Running</option>
            <option value="Lampadaria">Lampadaria</option>
            <option value="Latika">Latika</option>
            <option value="Leternel Ortomolecular - Creme TOE">Leternel Ortomolecular - Creme TOE</option>
            <option value="LET IT BE INTIMATE">LET IT BE INTIMATE</option>
            <option value="LG Holding">LG Holding</option>
            <option value="Lilaccie">Lilaccie</option>
            <option value="LM SOLUÇOES">LM SOLUÇOES</option>
            <option value="Loja Corrida Perfeita">Loja Corrida Perfeita</option>
            <option value="Ludopia Brinquedos Terapêuticos e Educativos">Ludopia Brinquedos Terapêuticos e Educativos</option>
            <option value="Mahta">Mahta</option>
            <option value="Mais Que um Café">Mais Que um Café</option>
            <option value="MAMD">MAMD</option>
            <option value="ManClub">ManClub</option>
            <option value="ManClub MG">ManClub MG</option>
            <option value="MapaLab">MapaLab</option>
            <option value="Mapear Direito">Mapear Direito</option>
            <option value="Mark Ryden Brasil">Mark Ryden Brasil</option>
            <option value="Median">Median</option>
            <option value="Mégalos Imports">Mgalos Imports</option>
            <option value="Meller BR">Meller BR</option>
            <option value="Monoï Original Precieux">Monoï Original Precieux</option>
            <option value="MOOSE baby e kids">MOOSE baby e kids</option>
            <option value="Mozambique">Mozambique</option>
            <option value="Namu Matcha">Namu Matcha</option>
            <option value="NOÀZIS">NOÀZIS</option>
            <option value="Nowhey Suplementos">Nowhey Suplementos</option>
            <option value="NutroSupp"></option>NutroSupp</option>
            <option value="oiwhite">oiwhite</option>
            <option value="Opera Beauty Brasil">Opera Beauty Brasil</option>
            <option value="Ozonivita">Ozonivita</option>    
            <option value="Pankz - Panquecas Americanas">Pankz - Panquecas Americanas</option>
            <option value="Pano Urbano">Pano Urbano</option>
            <option value="Parla">Parla</option>
            <option value="Perruche">Perruche</option>
            <option value="PRANA BEBIDAS LEVES">PRANA BEBIDAS LEVES</option>
            <option value="Quetzalli">Quetzalli</option>
            <option value="QuickPower®">QuickPower®</option>
            <option value="RAUTER LTDA">RAUTER LTDA</option>
            <option value="Sacia Mais">Sacia Mais</option>
            <option value="Sallpe">Sallpe</option>
            <option value="Shiguan">Shiguan</option>
            <option value="Simbioze Amazônica">Simbioze Amazônica</option>
            <option value="Smush Smart Mushrooms">Smush Smart Mushrooms</option>
            <option value="Soul Live">Soul Live</option>
            <option value="Stella Pietro Wine">Stella Pietro Wine</option>
            <option value="Suplint">Suplint</option>
            <option value="Tábua Cronológica da Bíblia">Tábua Cronológica da Bíblia</option>
            <option value="TAG Livros">TAG Livros</option>
            <option value="Takeya Brasil">Takeya Brasil</option>
            <option value="TERRAL NATURAL">TERRAL NATURAL</option>
            <option value="TerraNutri Pure">TerraNutri Pure</option>
            <option value="The Skin Belle">The Skin Belle</option>
            <option value="TucoMarket">TucoMarket</option>
            <option value="Ufoslabs">Ufoslabs</option>
            <option value="Urban Basics">Urban Basics</option>
            <option value="Vinsel">Vinsel</option>
            <option value="Violão Brasileiro">Violão Brasileiro</option>
            <option value="WeCann Academy">WeCann Academy</option>
            <!-- Add options dynamically -->
        </select>
        <select id="transportadora" class="filter-dropdown">
            <option value="None">Todas Transportadoras</option>
            <option value="JT Express">JT Express</option>
            <option value="LOGGI">LOGGI</option>
            <option value="CORREIOS">CORREIOS</option>
            <option value="CUBBO">CUBBO</option>
            <!-- Add options dynamically -->
        </select>
        <div class="date-input-container">
            <label for="dataInicio">Data Início</label>
            <input type="date" id="dataInicio" class="filter-date" onchange="this.value = this.value || null">
        </div>
        <div class="date-input-container">
            <label for="dataFim">Data Fim</label>
            <input type="date" id="dataFim" class="filter-date" onchange="this.value = this.value || null">
        </div>
        <select id="status" class="filter-dropdown">
            <option value="None">Todos Status</option>
            <option value="shipped">shipped</option>
            <option value="returned">returned</option>
            <option value="returning">returning</option>
            <!-- Add options dynamically -->
        </select>
        <button id="updateDataBtn" class="filter-button">Atualizar Dados</button>
    </div>

    <div class="dashboard">
        <div id="ufChart" class="chart">
            <h3 style="right: -10%; position: relative;">Atrasos por UF</h3>
            <canvas id="ufBarChart"></canvas>
        </div>

        <div id="pieChartContainer">
            <div id="legend" class="legend">
                <!-- The legend items will be dynamically inserted here -->
            </div>
            <div id="totalAtrasos">ATRASOS TOTAL: <span id="totalAtrasosValue">XXX</span></div>
            <div id="pieChartWrapper">
                <canvas id="transportadoraPieChart"></canvas>
            </div>
        </div>

        <div id="dateChart" class="chart">
            <h3 style="left: 60%; position: relative;">Atrasos por Data</h3>
            <canvas id="dateBarChart"></canvas>
        </div>
    </div>

    <!-- New section for the table of delayed orders -->
    <div id="atrasosTable" class="atrasos-table">
        <div id="atrasosTableHeader">
            <h3>Pedidos Atrasados</h3>
            <button><img id="downloadBtn" src="/static/images/download.png" alt="download"></button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Pedido</th>
                    <th>Rastreio</th>
                    <th>Transportadora</th>
                    <th>UF</th>
                    <th>Processado</th>
                    <th>Primeira Tentativa</th>
                    <th>Status</th>
                    <th>Entregue</th>
                    <th>Previsão de Entrega</th>
                    <th>SLA</th>
                    <th>Primeira Entrega</th>
                    <th>Atraso</th>
                </tr>
            </thead>
            <tbody id="atrasosTableBody">
                <!-- Table rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        let ufChart, pieChart, dateChart;

        // Function to update UF bar chart
        function updateUFChart(data) {
            const ctx = document.getElementById('ufBarChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (ufChart) {
                ufChart.destroy();
            }

            const labels = Object.keys(data);
            const datasets = [
                {
                    label: 'Loggi',
                    data: labels.map(uf => data[uf]['LOGGI'] || 0),
                    backgroundColor: 'aqua'
                },
                {
                    label: 'Correios',
                    data: labels.map(uf => data[uf]['CORREIOS'] || 0),
                    backgroundColor: 'chartreuse'
                },
                {
                    label: 'Cubbo',
                    data: labels.map(uf => data[uf]['CUBBO'] || 0),
                    backgroundColor: '#ed1e79'
                }
            ];

            ufChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: datasets.map(dataset => ({
                        ...dataset,
                        barThickness: 5 // Reduced bar thickness
                    }))
                },
                options: {
                    indexAxis: 'y',  // This makes the chart horizontal
                    scales: {
                        x: { 
                            stacked: false,
                            ticks: {
                                font: {
                                    size: 14 // Increased font size
                                }
                            }
                        },
                        y: { 
                            stacked: false,
                            ticks: {
                                autoSkip: false,
                                font: {
                                    size: 12 // Increased font size
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false  // Hide the legend
                        }
                    },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        }

        // Function to update transportadora pie chart
        function updatePieChart(data) {
            const ctx = document.getElementById('transportadoraPieChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (pieChart) {
                pieChart.destroy();
            }

            const labels = Object.keys(data);
            const values = labels.map(label => data[label].count);
            const colors = {
                'LOGGI': 'aqua',
                'CORREIOS': 'chartreuse',
                'CUBBO': '#ed1e79'
            };

            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: labels.map(label => colors[label])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Hide the legend
                        },
                        title: {
                            display: true,
                            text: 'Atrasos por Transportadora'
                        }
                    }
                }
            });
        }

        // Function to update date bar chart
        function updateDateChart(data) {
            const ctx = document.getElementById('dateBarChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (dateChart) {
                dateChart.destroy();
            }

            const labels = Object.keys(data).sort();
            const datasets = [
                {
                    label: 'Loggi',
                    data: labels.map(date => data[date]['LOGGI'] || 0),
                    backgroundColor: 'aqua'
                },
                {
                    label: 'Correios',
                    data: labels.map(date => data[date]['CORREIOS'] || 0),
                    backgroundColor: 'chartreuse'
                },
                {
                    label: 'Cubbo',
                    data: labels.map(date => data[date]['CUBBO'] || 0),
                    backgroundColor: '#ed1e79'
                }
            ];

            dateChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels, 
                    datasets: datasets.map(dataset => ({
                        ...dataset,
                        barThickness: 5 // Reduced bar thickness
                    }))
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            stacked: false,
                            position: 'top',
                            reverse: true,
                            ticks: {
                                font: {
                                    size: 14 // Increased font size
                                }
                            }
                        },
                        y: { 
                            stacked: false,
                            reverse: true,
                            ticks: {
                                autoSkip: false,
                                font: {
                                    size: 12 // Increased font size
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false  // Hide the legend
                        }
                    },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        }

        // Modified updateLegend function
        function updateLegend(transportadora) {
            const legendContainer = document.getElementById('legend');
            const allTransportadoras = [
                { name: 'Loggi', color: 'aqua' },
                { name: 'Correios', color: 'chartreuse' },
                { name: 'Cubbo', color: '#ed1e79' }
            ];

            // Clear existing legend items
            legendContainer.innerHTML = '';

            if (transportadora === 'None' || transportadora === '') {
                // If no specific transportadora is selected, show all
                allTransportadoras.forEach(t => {
                    legendContainer.innerHTML += `
                        <span class="legend-item">
                            <span style="color: ${t.color};">■</span> ${t.name}
                        </span>
                    `;
                });
                legendContainer.style.display = 'flex';
            } else {
                // If a specific transportadora is selected, hide the legend
                legendContainer.style.display = 'none';
            }
        }

        // Modified updateData function
        function updateData() {
            document.getElementById('updateDataBtn').disabled = true;
            document.getElementById('updateDataBtn').textContent = 'Atualizando...';

            // Get filter values
            const marca = document.getElementById('marca').value;
            const transportadora = document.getElementById('transportadora').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const status = document.getElementById('status').value;

            // Prepare the data to send
            const data = {
                marca: marca !== 'None' ? marca : '',
                transportadora: transportadora !== 'None' ? transportadora : '',
                data_inicial: dataInicio,
                data_final: dataFim,
                status: status !== 'None' ? status : ''
            };

            fetch('/update_atrasos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateUFChart(data.uf_data);
                    updatePieChart(data.transportadora_data);
                    updateDateChart(data.date_data);
                    document.getElementById('totalAtrasosValue').textContent = data.total_atrasos;
                    
                    // Update the legend based on the selected transportadora
                    updateLegend(transportadora);
                    
                    // New: Update the table of delayed orders
                    updateAtrasosTable(data.atrasos_list);
                    
                    alert('Dados atualizados com sucesso!');
                } else {
                    alert('Erro ao atualizar dados: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao atualizar dados: ' + error);
            })
            .finally(() => {
                document.getElementById('updateDataBtn').disabled = false;
                document.getElementById('updateDataBtn').textContent = 'Atualizar Dados';
            });
        }

        // New function to update the table of delayed orders
        function updateAtrasosTable(atrasosList) {
            const tableBody = document.getElementById('atrasosTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            atrasosList.forEach(atraso => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = atraso.store_name;
                row.insertCell(1).textContent = atraso.order_number;
                row.insertCell(2).textContent = atraso.rastreio;
                row.insertCell(3).textContent = atraso.transportadora;
                row.insertCell(4).textContent = atraso.UF;
                row.insertCell(5).textContent = atraso.processado;
                row.insertCell(6).textContent = atraso.first_delivery_attempt_at;
                row.insertCell(7).textContent = atraso.shipping_status;
                row.insertCell(8).textContent = atraso.delivered_at;
                row.insertCell(9).textContent = atraso.estimated_time_arrival;
                row.insertCell(10).textContent = atraso.SLA;
                row.insertCell(11).textContent = atraso.first_delivery;
                row.insertCell(12).textContent = atraso.atraso;
            });
        }

        // Add event listener to the update button
        document.getElementById('updateDataBtn').addEventListener('click', updateData);

        // Call updateCharts initially to load data and set up the legend
        

        // Add this function near the top of your script section
        function downloadToSheets() {
            fetch('/generate-sheets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Open the spreadsheet in a new tab
                    window.open(`https://docs.google.com/spreadsheets/d/${data.spreadsheet_id}`, '_blank');
                } else {
                    alert('Error generating spreadsheet: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating spreadsheet');
            });
        }

        // Add this event listener after your other event listeners
        document.getElementById('downloadBtn').addEventListener('click', downloadToSheets);

    </script>
</body>
</html>
